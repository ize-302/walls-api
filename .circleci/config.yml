# # This config was automatically generated from your source code
# # Stacks detected: deps:node:.,test:jest:
# version: 2.1
# orbs:
#   node: circleci/node@5
# jobs:
#   test-node:
#     # Install node dependencies and run tests
#     executor: node/default
#     environment:
#       JEST_JUNIT_OUTPUT_DIR: ./test-results/
#     steps:
#       - checkout
#       - node/install-packages:
#           pkg-manager: npm
#       - run:
#           command: npm install jest-junit
#       - run:
#           name: Run tests
#           command: npm run test --ci --runInBand --reporters=default --reporters=jest-junit
#       - store_test_results:
#           path: ./test-results/
#   deploy:
#     # This is an example deploy job, not actually used by the workflow
#     docker:
#       - image: cimg/base:stable
#     steps:
#       # Replace this with steps to deploy to users
#       - run:
#           name: deploy
#           command: '#e.g. ./deploy.sh'
# workflows:
#   build-and-test:
#     jobs:
#       - test-node
#     # - deploy:
#     #     requires:
#     #       - test-node

# .circleci/config.yml
version: 2.1

orbs:
  node: circleci/node@5

workflows:
  test_my_app:
    jobs:
      - build_and_test:
          context: admin

jobs:
  build_and_test:
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: "Create .env.testing"
          command: |
            echo "BASE_PATH=${BASE_PATH}" > .env.testing
            echo "PORT=${PORT}" >> .env.testing
            echo "TURSO_DATABASE_URL=${TURSO_DATABASE_URL}" >> .env.testing
            echo "TURSO_DATABASE_AUTH_TOKEN=${TURSO_DATABASE_AUTH_TOKEN}" >> .env.testing
            echo "SESSION_SECRET=${SESSION_SECRET}" >> .env.testing
            echo "NODE_ENV=${NODE_ENV}" >> .env.testing
      - run: npm install cross-env
      - run: npm install
      - run: npm test